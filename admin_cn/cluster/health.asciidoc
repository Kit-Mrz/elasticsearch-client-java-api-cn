[[java-admin-cluster-health]]
==== 集群健康

[[java-admin-cluster-health-health]]
===== 健康

集群健康 API 允许用户获取有关集群健康的一个非常简单的状态并且也可以给你一些有关每个索引的集群状态的技术信息:

[source,java]
--------------------------------------------------
ClusterHealthResponse healths = client.admin().cluster().prepareHealth().get(); <1>
String clusterName = healths.getClusterName();              <2>
int numberOfDataNodes = healths.getNumberOfDataNodes();     <3>
int numberOfNodes = healths.getNumberOfNodes();             <4>

for (ClusterIndexHealth health : healths.getIndices().values()) { <5>
    String index = health.getIndex();                       <6>
    int numberOfShards = health.getNumberOfShards();        <7>
    int numberOfReplicas = health.getNumberOfReplicas();    <8>
    ClusterHealthStatus status = health.getStatus();        <9>
}
--------------------------------------------------
<1> 获取所有索引信息
<2> 获取集群名称
<3> 获取数据节点总数
<4> 获取节点总数
<5> 遍历所有索引
<6> 索引名称
<7> 分片数量
<8> 副本数量
<9> 索引状态

[[java-admin-cluster-health-wait-status]]
===== 等待特定状态

你可以使用集群健康 API 来等待整个集群或指定的索引达到一个特定的状态:

[source,java]
--------------------------------------------------
client.admin().cluster().prepareHealth()            <1>
        .setWaitForYellowStatus()                   <2>
        .get();
client.admin().cluster().prepareHealth("company")   <3>
        .setWaitForGreenStatus()                    <4>
        .get();

client.admin().cluster().prepareHealth("employee")  <5>
        .setWaitForGreenStatus()                    <6>
        .setTimeout(TimeValue.timeValueSeconds(2))  <7>
        .get();
--------------------------------------------------
<1> 准备一个健康请求对象
<2> 等待集群状态变成 yellow
<3> 为 `company` 索引准备健康请求对象
<4> 等待索引状态变成 green
<5> 为 `employee` 索引准备健康请求对象
<6> 等待索引状态变成 green
<7> 最多等待 2s

如果索引没有达到预期的状态值并且你想在这种情况下失败, 你需要显示地中断结果:

[source,java]
--------------------------------------------------
ClusterHealthResponse response = client.admin().cluster().prepareHealth("company")
        .setWaitForGreenStatus()    <1>
        .get();

ClusterHealthStatus status = response.getIndices().get("company").getStatus();
if (!status.equals(ClusterHealthStatus.GREEN)) {
    throw new RuntimeException("Index is in " + status + " state"); <2>
}
--------------------------------------------------
<1> 等待索引状态变成 green
<2> 如果不是 `GREEN` 抛出异常
